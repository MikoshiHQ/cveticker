# pylint: disable=missing-ignore
import pytest

from modules.nist.nist import parse_nist_html, get_content_for_output

MOCK_CVE = "CVE-2024-32109"
MOCK_NIST_HTML_RESPONSE = """
<div class="col-lg-3 col-sm-6">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<span><strong>Base\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tScore:</strong>&nbsp;<span class="severityDetail"> <a\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tid="Cvss3CnaCalculatorAnchor"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\thref="/vuln-metrics/cvss/v3-calculator?name=CVE-2024-32109&amp;vector=AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N&amp;version=3.1&amp;source=Patchstack"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdata-testid="vuln-cvss3-cna-panel-score"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclass="label label-warning">4.3 MEDIUM</a></span></span>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>
 \r\n\t\t\t\t\t\t\t\t\t\t\t"""

MOCK_DB_DATA = {"resultsPerPage": 4, "startIndex": 0, "totalResults": 4, "format": "NVD_CVE", "version": "2.0", "timestamp": "2024-04-11T16:24:50.233", "vulnerabilities": [{"cve": {"id": "CVE-2023-29483", "sourceIdentifier": "cve@mitre.org", "published": "2024-04-11T14:15:12.010", "lastModified": "2024-04-11T14:15:12.010", "vulnStatus": "Received", "descriptions": [{"lang": "en", "value": "eventlet before 0.35.2, as used in dnspython before 2.6.0, allows remote attackers to interfere with DNS name resolution by quickly sending an invalid packet from the expected IP address and source port, aka a \"TuDoor\" attack. In other words, dnspython does not have the preferred behavior in which the DNS name resolution algorithm would proceed, within the full time window, in order to wait for a valid packet. NOTE: dnspython 2.6.0 is unusable for a different reason that was addressed in 2.6.1."}], "metrics": {}, "references": [{"url": "https://github.com/eventlet/eventlet/issues/913", "source": "cve@mitre.org"}, {"url": "https://github.com/eventlet/eventlet/releases/tag/v0.35.2", "source": "cve@mitre.org"}, {"url": "https://github.com/rthalley/dnspython/issues/1045", "source": "cve@mitre.org"}, {"url": "https://github.com/rthalley/dnspython/releases/tag/v2.6.0", "source": "cve@mitre.org"}, {"url": "https://security.snyk.io/vuln/SNYK-PYTHON-DNSPYTHON-6241713", "source": "cve@mitre.org"}, {"url": "https://www.dnspython.org/", "source": "cve@mitre.org"}]}}, {"cve": {"id": "CVE-2024-32105", "sourceIdentifier": "audit@patchstack.com", "published": "2024-04-11T14:15:12.143", "lastModified": "2024-04-11T14:15:12.143", "vulnStatus": "Received", "descriptions": [{"lang": "en", "value": "Cross-Site Request Forgery (CSRF) vulnerability in ELEXtensions ELEX WooCommerce Dynamic Pricing and Discounts.This issue affects ELEX WooCommerce Dynamic Pricing and Discounts: from n/a through 2.1.2.\n\n"}], "metrics": {"cvssMetricV31": [{"source": "audit@patchstack.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 1.4}]}, "weaknesses": [{"source": "audit@patchstack.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-352"}]}], "references": [{"url": "https://patchstack.com/database/vulnerability/elex-woocommerce-dynamic-pricing-and-discounts/wordpress-elex-woocommerce-dynamic-pricing-and-discounts-plugin-2-1-2-cross-site-request-forgery-csrf-vulnerability-2?_s_id=cve", "source": "audit@patchstack.com"}]}}, {"cve": {"id": "CVE-2024-0881", "sourceIdentifier": "contact@wpscan.com", "published": "2024-04-11T16:15:24.800", "lastModified": "2024-04-11T16:15:24.800", "vulnStatus": "Received", "descriptions": [{"lang": "en", "value": "The Post Grid, Form Maker, Popup Maker, WooCommerce Blocks, Post Blocks, Post Carousel  WordPress plugin before 2.2.76 does not prevent password protected posts from being displayed in the result of some unauthenticated AJAX actions, allowing unauthenticated users to read such posts"}], "metrics": {}, "references": [{"url": "https://wpscan.com/vulnerability/e460e926-6e9b-4e9f-b908-ba5c9c7fb290/", "source": "contact@wpscan.com"}]}}, {"cve": {"id": "CVE-2024-31678", "sourceIdentifier": "cve@mitre.org", "published": "2024-04-11T16:15:25.127", "lastModified": "2024-04-11T16:15:25.127", "vulnStatus": "Received", "descriptions": [{"lang": "en", "value": "Sourcecodester Loan Management System v1.0 is vulnerable to SQL Injection via the \"password\" parameter in the \"login.php\" file."}], "metrics": {}, "references": [{"url": "https://github.com/CveSecLook/cve/issues/10", "source": "cve@mitre.org"}]}}]}


def test_parse_nist_html():
    assert parse_nist_html(html=MOCK_NIST_HTML_RESPONSE, cve=MOCK_CVE) == '4.3'

def test_get_content_for_output():
    for i in range(MOCK_DB_DATA['totalResults']):
        assert get_content_for_output(MOCK_DB_DATA, i)
